# Todoist 連携が必須の場合の整理

## いまできていること（必須のうち実装済み）

| 機能 | 状態 |
|------|------|
| 管理ツールでプロジェクト／タスク作成 → Todoist にタスク自動作成 | ✅ 実装済み（設定でトークン・デフォルトプロジェクトを保存すれば本番でも動作） |
| Todoist のプロジェクト一覧取得 | ✅ 実装済み（userToken または環境変数） |
| 「進捗を同期」で Todoist の完了状態を管理ツールに反映 | ✅ 実装済み（userToken 対応済み） |
| Webhook エンドポイントの受信 | ✅ 実装済み（`/api/todoist/webhook`、署名検証あり） |

## 必須として足りていない部分

| 機能 | 状態 | 必要な対応 |
|------|------|------------|
| **Todoist でタスクを完了 → 管理ツールの進捗が自動で上がる** | ❌ 未実装 | **DB 必須**。Webhook で受け取った「完了」を保存し、画面がそれを参照する必要がある。 |

→ **「Todoist 連携が必須」を完全に満たすには、この自動反映のため DB 導入が前提になります。**

## 推奨する進め方（Todoist 必須の場合）

1. **DB を導入する**  
   - Vercel なら **Vercel Postgres（Neon）** が扱いやすい。  
   - テーブル例: チェックリスト／タスク／タスクと Todoist の紐づけ（`todoist_id` など）、完了フラグ・更新日時。

2. **Webhook で「完了」を DB に書き込む**  
   - `item:completed` を受信したら、該当する `todoist_id` のレコードを「完了」に更新。

3. **画面は DB を参照する**  
   - チェックリスト・進捗は DB から取得し、Webhook で更新された内容がそのまま反映されるようにする。

4. **（任意）タスク作成時も DB に保存**  
   - 管理ツールでタスクを作成したときに DB に書き、同じレコードに `todoist_id` を保存しておくと、Webhook で「どのタスクが完了したか」を一意に判定しやすい。

## まとめ

- **現状**: 「タスクを Todoist に送る」「進捗を手動で同期する」までは実装済みで、**ここまでなら DB なしでも必須の一部は満たせている**。
- **「Todoist で完了 → 自動で進捗が上がる」まで必須にする**: **DB を導入し、Webhook で DB を更新する実装が必要**。

次のステップとして、DB スキーマ案と Webhook の更新処理の実装から進めるのがおすすめです。
