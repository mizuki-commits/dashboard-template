# Todoist 連携の不備と改善点

## 現状で問題になっている点

### 1. **ログイン解除とAPIの不整合** → **対応済み**
- create-task は「ログイン済み」または「リクエストに userToken あり」で実行可能。設定でトークンを保存すれば本番でタスク自動作成が動作する。
- user-token API はログイン時用。現状はトークンを設定画面で localStorage に保存するため未使用でよい。

---

### 2. **Webhook 受信後の進捗更新が未実装**
- **現象**: `handleTaskCompleted` 内が「TODO」のまま。ログのみで、管理ツール側のデータは更新していない。
- **理由**: チェックリスト／タスクボードの状態が **DB ではなくメモリ（React state）** のため、Webhook から参照・更新する永続ストアがない。
- **影響**: 「Todoist でタスクを完了 → 管理ツールの進捗が自動で上がる」は **実現していない**。進捗反映は「進捗を同期」ボタン（sync-status API + フロントの更新）のみ。
- **推奨対応**: DB を導入するか、Webhook で Redis 等に「完了した todoistId」を書き、フロントがポーリングで参照するなどの設計が必要。

---

### 3. **sync-status / sync API のユーザートークン対応** → **対応済み**
- sync-status と sync の両方でリクエストに `userToken` を含めれば、サーバーに `TODOIST_API_TOKEN` がなくても動作する。

---

### 4. **担当者（Assignee）の Todoist 連携がない**
- **現象**: チェックリストのサブタスクには「MIZUKI」「NISHIKATA」などの担当者があるが、Todoist タスク作成時に **assigneeId を渡していない**。また Todoist の `assignee_id` は「コラボレーターID」が必要で、アプリ側の名前と対応づけしていない。
- **影響**: 管理ツールで担当者を選んでも、Todoist 側のタスクには担当者が付かない。
- **推奨対応**: 担当者名 → Todoist のコラボレーターID のマッピング（設定または DB）を用意し、create-task で `assigneeId` を渡す。

---

### 5. **優先度（Priority）を渡していない**
- **現象**: `createTask` は `priority` を受け取れるが、チェックリストからタスク作成する際に **priority を指定していない**（常に Todoist デフォルト）。
- **影響**: 管理ツール側で優先度を扱っていないため、現状の不具合というより「仕様として未実装」。

---

### 6. **Webhook の署名検証が必須**
- **現象**: `TODOIST_WEBHOOK_SECRET` が未設定だと `getWebhookSecret()` が例外を投げ、Webhook が 500 になる。
- **影響**: 環境変数を設定していないと、Todoist の Webhook 登録が動かない。
- **推奨対応**: シークレット未設定時は署名検証をスキップするオプションを設けるか、ドキュメントで「Webhook を使う場合は必須」と明記する。

---

### 7. **データの永続化がない**
- **現象**: チェックリスト・タスクボード・KPI などは React state（＋一部 localStorage）のみ。DB なし。
- **影響**: 再読み込みや別デバイスでは状態が共有されない。Webhook で「進捗を自動反映」する先のストアもない。
- **推奨対応**: 必要に応じて DB（Prisma 等）を導入し、タスク・進捗を永続化する。

---

## まとめ

| 項目 | 深刻度 | 状態 |
|------|--------|------|
| ログイン解除後の create-task が 401 | 高 | **対応済み**（userToken で認証） |
| sync / sync-status が userToken 非対応 | 高 | **対応済み**（userToken 対応） |
| Webhook 受信後の進捗更新 | 中 | 未実装（DB 等が必要。現状は「進捗を同期」ボタンで手動反映） |
| 担当者を Todoist に反映 | 中 | 未実装 |
| 優先度の連携 | 低 | 未実装 |
| Webhook シークレット未設定時の挙動 | 低 | **対応済み**（未設定時は 503 を返す） |
| データ永続化 | 設計 | DB 導入で検討 |

現状の実用化: ログインなし・サーバーに TODOIST_API_TOKEN なしでも、**設定でTodoistトークンとデフォルトプロジェクトを保存**すれば「タスク作成」「タスク取り込み（同期）」「進捗を同期」が本番で動作します。
